<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto de Venta</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <div class="header-left">
            <h1>Sistema de Ventas</h1>
            <div class="search-container">
                <input type="text" id="search-input" placeholder="Buscar producto..." oninput="filtrarProductos()">
            </div>
        </div>

        <div class="caja-diaria-card">
            <span class="caja-label">Caja del Día</span>
            <span class="caja-monto" id="caja-dia-monto">$0.00</span>
        </div>
    </header>

    <main>
        <section class="products-section">
            <div class="products-header">
                <h2>Inventario</h2>
                <button class="btn-secondary" onclick="toggleFormulario()">+ Nuevo Producto</button>
            </div>

            <div id="form-producto" class="form-producto hidden">
                <h3>Agregar Producto</h3>
                <div class="form-row">
                    <input type="text" id="new-nombre" placeholder="Nombre">
                    <input type="number" id="new-precio" placeholder="Precio ($)">
                    <input type="number" id="new-stock" placeholder="Stock">
                </div>
                <div class="form-actions">
                    <button class="btn-success" onclick="guardarProducto()">Guardar</button>
                    <button class="btn-cancel" onclick="toggleFormulario()">Cancelar</button>
                </div>
            </div>

            <div id="products-grid" class="products-grid">
                <p>Cargando productos...</p>
            </div>
        </section>

        <section class="cart-section">
            <h2>Carrito de Compras</h2>
            <div id="cart-items" class="cart-items">
                <p class="empty-msg">El carrito está vacío</p>
            </div>

            <div class="cart-summary">
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="subtotal">$0.00</span>
                </div>
                <div class="summary-row" style="align-items: center;">
                    <span>IVA (%):</span>
                    <input type="number" id="iva-rate" value="21" onchange="renderizarCarrito()" style="width: 50px; padding: 2px;">
                </div>
                <div class="summary-row">
                    <span>Monto IVA:</span>
                    <span id="iva-amount">$0.00</span>
                </div>
                <div class="summary-row total-row">
                    <span>Total:</span>
                    <span id="total">$0.00</span>
                </div>
                <button id="btn-checkout" class="btn-checkout" onclick="procesarVenta()">Confirmar Venta</button>
            </div>
        </section>
    </main>

    <script>
        // Estado de la aplicación
        let inventario = [];
        let carrito = [];

        // Elementos del DOM
        const gridProductos = document.getElementById('products-grid');
        const listaCarrito = document.getElementById('cart-items');
        const elSubtotal = document.getElementById('subtotal');
        const elIvaAmount = document.getElementById('iva-amount');
        const elIvaRate = document.getElementById('iva-rate');
        const elTotal = document.getElementById('total');
        const inputBusqueda = document.getElementById('search-input');
        const formProducto = document.getElementById('form-producto');
        const elCajaMonto = document.getElementById('caja-dia-monto');

        // --- FUNCIONES DE INICIO ---
        
        async function cargarInventario() {
            try {
                const res = await fetch('/api/inventario');
                inventario = await res.json();
                renderizarProductos();
            } catch (error) {
                console.error('Error cargando inventario:', error);
                gridProductos.innerHTML = '<p>Error al conectar con el servidor.</p>';
            }
        }

        async function actualizarCajaDiaria() {
            try {
                const res = await fetch('/api/caja-diaria');
                const data = await res.json();
                elCajaMonto.textContent = `$${data.total.toFixed(2)}`;
                
                // Animación simple
                elCajaMonto.style.color = '#4ade80';
                setTimeout(() => elCajaMonto.style.color = '', 500);
            } catch (error) {
                console.error('Error cargando caja:', error);
            }
        }

        // --- PRODUCTOS ---

        function renderizarProductos(filtro = '') {
            gridProductos.innerHTML = '';
            
            const productosFiltrados = inventario.filter(p => 
                p.nombre.toLowerCase().includes(filtro.toLowerCase())
            );

            if (productosFiltrados.length === 0) {
                gridProductos.innerHTML = '<p>No se encontraron productos.</p>';
                return;
            }

            productosFiltrados.forEach(producto => {
                const card = document.createElement('div');
                card.className = 'product-card';
                
                const sinStock = producto.stock <= 0;
                
                card.innerHTML = `
                    <div>
                        <div class="product-name">${producto.nombre}</div>
                        <div class="product-price">$${producto.precio}</div>
                        <div class="product-stock">Stock: ${producto.stock} u.</div>
                    </div>
                    <button 
                        class="btn-add" 
                        onclick="agregarAlCarrito(${producto.id})"
                        ${sinStock ? 'disabled' : ''}
                    >
                        ${sinStock ? 'Sin Stock' : 'Agregar'}
                    </button>
                `;
                gridProductos.appendChild(card);
            });
        }

        function filtrarProductos() {
            const texto = inputBusqueda.value;
            renderizarProductos(texto);
        }

        function toggleFormulario() {
            formProducto.classList.toggle('hidden');
        }

        async function guardarProducto() {
            const nombre = document.getElementById('new-nombre').value;
            const precio = parseFloat(document.getElementById('new-precio').value);
            const stock = parseInt(document.getElementById('new-stock').value);

            if (!nombre || isNaN(precio) || isNaN(stock)) {
                alert('Por favor complete todos los campos correctamente.');
                return;
            }

            const nuevoProducto = { nombre, precio, stock };

            try {
                const res = await fetch('/api/productos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(nuevoProducto)
                });

                if (res.ok) {
                    alert('Producto agregado correctamente');
                    document.getElementById('new-nombre').value = '';
                    document.getElementById('new-precio').value = '';
                    document.getElementById('new-stock').value = '';
                    toggleFormulario();
                    cargarInventario(); 
                } else {
                    alert('Error al guardar producto');
                }
            } catch (error) {
                console.error(error);
                alert('Error de conexión');
            }
        }

        // --- CARRITO ---

        function agregarAlCarrito(id) {
            const producto = inventario.find(p => p.id === id);
            const itemEnCarrito = carrito.find(item => item.id === id);
            const cantidadEnCarrito = itemEnCarrito ? itemEnCarrito.cantidad : 0;

            if (producto.stock > cantidadEnCarrito) {
                if (itemEnCarrito) {
                    itemEnCarrito.cantidad++;
                } else {
                    carrito.push({
                        id: producto.id,
                        nombre: producto.nombre,
                        precio: producto.precio,
                        cantidad: 1
                    });
                }
                renderizarCarrito();
            } else {
                alert('No hay suficiente stock disponible.');
            }
        }

        function cambiarCantidad(id, delta) {
            const item = carrito.find(i => i.id === id);
            const producto = inventario.find(p => p.id === id);
            
            if (!item) return;

            const nuevaCantidad = item.cantidad + delta;

            if (nuevaCantidad > 0) {
                if (delta > 0 && nuevaCantidad > producto.stock) {
                    alert('No hay más stock disponible.');
                    return;
                }
                item.cantidad = nuevaCantidad;
            } else {
                quitarDelCarrito(id);
                return;
            }
            renderizarCarrito();
        }

        function quitarDelCarrito(id) {
            const index = carrito.findIndex(item => item.id === id);
            if (index !== -1) {
                carrito.splice(index, 1);
                renderizarCarrito();
            }
        }

        function renderizarCarrito() {
            listaCarrito.innerHTML = '';
            
            if (carrito.length === 0) {
                listaCarrito.innerHTML = '<p class="empty-msg">El carrito está vacío</p>';
                actualizarTotales(0);
                return;
            }

            let subtotalAcumulado = 0;

            carrito.forEach(item => {
                const subtotalItem = item.cantidad * item.precio;
                subtotalAcumulado += subtotalItem;
                
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <div class="cart-item-info">
                        <h4>${item.nombre}</h4>
                        <span>$${item.precio} c/u</span>
                    </div>
                    <div class="cart-controls">
                        <button class="btn-qty" onclick="cambiarCantidad(${item.id}, -1)">-</button>
                        <span class="qty-display">${item.cantidad}</span>
                        <button class="btn-qty" onclick="cambiarCantidad(${item.id}, 1)">+</button>
                    </div>
                    <div class="cart-price">
                        <strong>$${subtotalItem}</strong>
                    </div>
                `;
                listaCarrito.appendChild(div);
            });

            actualizarTotales(subtotalAcumulado);
        }

        function actualizarTotales(subtotal) {
            const tasaIva = parseFloat(elIvaRate.value) || 0;
            const iva = subtotal * (tasaIva / 100);
            const total = subtotal + iva;

            elSubtotal.textContent = `$${subtotal.toFixed(2)}`;
            elIvaAmount.textContent = `$${iva.toFixed(2)}`;
            elTotal.textContent = `$${total.toFixed(2)}`;
        }

        async function procesarVenta() {
            if (carrito.length === 0) {
                alert('El carrito está vacío.');
                return;
            }

            const subtotalText = elSubtotal.textContent.replace('$','');
            const subtotal = parseFloat(subtotalText);
            const tasaIva = parseFloat(elIvaRate.value);
            const totalText = elTotal.textContent.replace('$','');
            const total = parseFloat(totalText);

            const ventaData = {
                fecha: new Date().toISOString(),
                items: carrito.map(i => ({...i, subtotal: i.cantidad * i.precio})),
                subtotal: subtotal,
                iva_porcentaje: tasaIva,
                total: total
            };

            try {
                const res = await fetch('/api/ventas', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(ventaData)
                });

                const resultado = await res.json();

                if (res.ok) {
                    alert('¡Venta realizada con éxito! Ticket generado.');
                    carrito = [];
                    renderizarCarrito();
                    cargarInventario(); // Recargar stock
                    actualizarCajaDiaria(); // Actualizar caja
                } else {
                    alert('Error: ' + resultado.error);
                }
            } catch (error) {
                console.error('Error procesando venta:', error);
                alert('Error de conexión.');
            }
        }

        // Inicio
        cargarInventario();
        actualizarCajaDiaria();
    </script>
</body>
</html>